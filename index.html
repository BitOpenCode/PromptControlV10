<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>ECOS AGI Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: '#1A1C1F',
            cardGlass: 'rgba(255, 255, 255, 0.08)',
          },
          boxShadow: {
            glass: '0 8px 32px rgba(0, 0, 0, 0.2)',
          },
          backdropBlur: {
            md: '16px',
          },
        },
      },
    };
  </script>
  <style>
    html, body {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(18px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .apple-card {
      background: rgba(255, 255, 255, 0.06);
      border: 1.5px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      box-shadow: 0 10px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      transition: all 0.3s ease;
    }

    .apple-card:hover {
      border-color: rgba(255, 255, 255, 0.18);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }

    .apple-input {
      background: rgba(255, 255, 255, 0.06);
      border: 1.5px solid rgba(255, 255, 255, 0.12);
      color: white;
      padding: 0.85rem 1.1rem;
      border-radius: 16px;
      font-size: 1rem;
      backdrop-filter: blur(14px);
      transition: border 0.3s, background 0.3s;
    }

    .apple-input:focus {
      border: 1.5px solid #3b82f6;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .apple-btn {
      background: rgba(255, 255, 255, 0.07);
      color: #fff;
      border-radius: 14px;
      font-weight: 600;
      padding: 0.6rem 1.1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(10px);
    }

    .apple-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
    }

    .apple-btn:active {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(0.98);
    }

    .collapsed {
      max-height: 4.5rem;
      overflow: hidden;
      position: relative;
    }

    .collapsed::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1.5rem;
      background: linear-gradient(to bottom, rgba(17,24,39,0) 0%, rgba(17,24,39,1) 100%);
    }

    .fade-in {
      animation: fadeIn 0.7s cubic-bezier(0.4,0,0.2,1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to   { opacity: 1; transform: none; }
    }

    #toast.show {
      opacity: 1 !important;
      transform: translateY(0) scale(1.05);
    }

    @media (max-width: 640px) {
      .apple-card { border-radius: 16px; }
      .apple-btn { border-radius: 12px; font-size: 1rem; }
      .apple-input { border-radius: 12px; font-size: 1rem; }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-br from-[#181a1e] via-[#23272f] to-[#23272f] text-gray-100 font-sans">

  <header class="w-full py-4 px-6 glass shadow-lg flex items-center gap-4 rounded-b-2xl mb-2 sticky top-0 z-30">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-sky-200 drop-shadow">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
      <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5" fill="none"/>
    </svg>
    <h1 class="text-2xl font-bold tracking-wide text-white drop-shadow flex-1">ECOS AGI Manager</h1>
    <div class="flex gap-2">
      <button id="profileBtn" onclick="showProfile()" class="apple-btn px-4 py-2 text-sm !bg-indigo-600 hover:!bg-indigo-500 no-gradient" style="display:none;">Личный кабинет</button>
      <button id="logoutBtn" onclick="logout()" class="apple-btn px-4 py-2 text-sm !bg-rose-600 hover:!bg-rose-500 no-gradient" style="display:none;">Выйти</button>
    </div>
  </header>

  <section class="max-w-2xl mx-auto w-full px-4 sm:px-0 mt-2 mb-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div id="stats" class="text-sm text-gray-400 select-none"></div>
    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
      <input id="searchInput" type="text" placeholder="Поиск…" class="apple-input w-full sm:w-48" />
      <select id="searchField" class="apple-input w-full sm:w-32">
        <option value="prompt">Текст</option>
        <option value="code">Код</option>
        <option value="created_at">Дата создания</option>
        <option value="updated_at">Дата изменения</option>
      </select>
      <select id="sortField" class="apple-input w-full sm:w-32">
        <option value="created_at">Сортировать: Создан</option>
        <option value="updated_at">Сортировать: Изменён</option>
        <option value="prompt">Сортировать: Текст</option>
        <option value="code">Сортировать: Код</option>
      </select>
      <select id="sortDir" class="apple-input w-full sm:w-24">
        <option value="desc">↓</option>
        <option value="asc">↑</option>
      </select>
      <label class="flex items-center gap-1 text-xs text-gray-400 select-none"><input type="checkbox" id="filterChanged" class="accent-sky-500"> Только изменённые</label>
      <button id="exportBtn" class="apple-btn px-3 py-1">Экспорт</button>
      <input type="file" id="importInput" accept=".json,.csv" class="hidden" />
      <button id="importBtn" class="apple-btn px-3 py-1">Импорт</button>
    </div>
  </section>

  <main id="promptList" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-5 max-w-2xl mx-auto w-full"></main>

  <form id="newPromptForm" class="w-full glass sticky bottom-0 p-4 flex gap-3 rounded-t-2xl shadow-2xl max-w-2xl mx-auto">
    <textarea id="promptInput" placeholder="Введите ваш промпт…" rows="2" class="apple-input flex-1 resize-none min-h-[48px] max-h-60 overflow-y-auto" required></textarea>
    <button id="saveBtn" type="submit" class="apple-btn px-7 py-3 disabled:opacity-50 disabled:pointer-events-none">
      <span class="hidden sm:inline">Отправить</span>
      <svg class="sm:hidden w-6 h-6 mx-auto" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
    </button>
  </form>

  <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 glass text-gray-100 px-5 py-3 rounded-xl shadow-2xl opacity-0 pointer-events-none transition-all duration-300 z-50 text-base font-medium"></div>

  <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition">
    <form id="loginForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Вход в админку</h2>
      <input id="loginInput" class="apple-input w-full" placeholder="Логин" autocomplete="username" required />
      <div class="relative">
        <input id="passwordInput" class="apple-input w-full pr-12" type="password" placeholder="Пароль" autocomplete="current-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('passwordInput', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <button id="loginBtn" type="submit" class="apple-btn px-4 py-2 !bg-sky-600 text-white font-semibold hover:!bg-sky-500 no-gradient">Войти</button>
      <div id="loginError" class="text-center text-rose-400 text-sm hidden">Ошибка входа</div>
      <div class="text-center space-y-2">
        <button type="button" id="showRegisterBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Нет аккаунта? Зарегистрироваться</button>
        <br>
        <button type="button" id="showResetBtn" class="text-amber-400 hover:text-amber-300 text-sm underline">Забыли пароль?</button>
      </div>
    </form>
  </div>

  <div id="registerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="registerForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Регистрация</h2>
      <input id="registerEmail" class="apple-input w-full" type="email" placeholder="Email" autocomplete="email" required />
      <input id="registerLogin" class="apple-input w-full" placeholder="Логин" autocomplete="username" required />
      <div class="relative">
        <input id="registerPassword" class="apple-input w-full pr-12" type="password" placeholder="Пароль" autocomplete="new-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('registerPassword', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <input id="registerName" class="apple-input w-full" placeholder="Имя" autocomplete="name" required />
      <button id="registerBtn" type="submit" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Зарегистрироваться</button>
      <div id="registerError" class="text-center text-rose-400 text-sm hidden">Ошибка регистрации</div>
      <div class="text-center">
        <button type="button" id="showLoginBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Уже есть аккаунт? Войти</button>
      </div>
    </form>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="confirmForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Подтверждение email</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Мы отправили код подтверждения на ваш email</p>
      <input id="confirmCode" class="apple-input w-full text-center text-xl tracking-widest" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required />
      <button id="confirmBtn" type="submit" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Подтвердить</button>
      <div id="confirmError" class="text-center text-rose-400 text-sm hidden">Ошибка подтверждения</div>
      <div class="text-center">
        <button type="button" id="resendCodeBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Отправить код повторно</button>
      </div>
    </form>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="resetForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Восстановление пароля</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Введите email для восстановления пароля</p>
      <input id="resetEmail" class="apple-input w-full" type="email" placeholder="Email" autocomplete="email" required />
      <button id="resetBtn" type="submit" class="apple-btn px-4 py-2 !bg-amber-600 text-white font-semibold hover:!bg-amber-500 no-gradient">Отправить код</button>
      <div id="resetError" class="text-center text-rose-400 text-sm hidden">Ошибка восстановления</div>
      <div class="text-center">
        <button type="button" id="showLoginFromResetBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Вернуться к входу</button>
      </div>
    </form>
  </div>

  <!-- Reset Confirm Modal -->
  <div id="resetConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="resetConfirmForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Новый пароль</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Введите код и новый пароль</p>
      <input id="resetCode" class="apple-input w-full text-center text-xl tracking-widest" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required />
      <div class="relative">
        <input id="newPassword" class="apple-input w-full pr-12" type="password" placeholder="Новый пароль" autocomplete="new-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('newPassword', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <div class="relative">
        <input id="confirmPassword" class="apple-input w-full pr-12" type="password" placeholder="Подтвердите пароль" autocomplete="new-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('confirmPassword', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <button id="resetConfirmBtn" type="submit" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Сохранить пароль</button>
      <div id="resetConfirmError" class="text-center text-rose-400 text-sm hidden">Ошибка подтверждения</div>
      <div class="text-center">
        <button type="button" id="resendResetCodeBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Отправить код повторно</button>
      </div>
    </form>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <div class="glass rounded-2xl p-6 shadow-2xl w-full max-w-md flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Личный кабинет</h2>
      
      <div class="space-y-3">
        <div class="bg-gray-800/50 rounded-lg p-3">
          <label class="text-sm text-gray-400">Логин:</label>
          <div id="profileLogin" class="text-gray-100 font-medium">-</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
          <label class="text-sm text-gray-400">Email:</label>
          <div id="profileEmail" class="text-gray-100 font-medium">-</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
          <label class="text-sm text-gray-400">Статус:</label>
          <div id="profileRole" class="text-gray-100 font-medium">Пользователь</div>
        </div>
        <div id="myPromptsSection" class="bg-gray-800/50 rounded-lg p-3 hidden">
          <label class="text-sm text-gray-400">Мои промпты:</label>
          <div id="myPromptsCount" class="text-gray-100 font-medium">0</div>
          <button id="viewMyPromptsBtn" class="text-sky-400 hover:text-sky-300 text-sm underline mt-1">Показать только мои</button>
        </div>
      </div>
      
      <div class="flex flex-col gap-3 mt-4">
        <button id="changePasswordBtn" class="apple-btn px-4 py-2 !bg-amber-600 hover:!bg-amber-500 no-gradient">Изменить пароль</button>
        <button id="requestEditorBtn" class="apple-btn px-4 py-2 !bg-purple-600 hover:!bg-purple-500 no-gradient hidden">Стать редактором</button>
        <button id="closeProfileBtn" class="apple-btn px-4 py-2 bg-gray-700 hover:bg-gray-600">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="changePasswordForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Изменение пароля</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Мы отправим код подтверждения на ваш email</p>
      <button id="sendChangeCodeBtn" type="submit" class="apple-btn px-4 py-2 !bg-amber-600 text-white font-semibold hover:!bg-amber-500 no-gradient">Отправить код</button>
      <div id="changePasswordError" class="text-center text-rose-400 text-sm hidden">Ошибка отправки</div>
      <div class="text-center">
        <button type="button" id="cancelChangePasswordBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Отмена</button>
      </div>
    </form>
  </div>

  <!-- Change Password Confirm Modal -->
  <div id="changePasswordConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="changePasswordConfirmForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Новый пароль</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Введите код и новый пароль</p>
      <input id="changeCode" class="apple-input w-full text-center text-xl tracking-widest" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required />
      <div class="relative">
        <input id="changeNewPassword" class="apple-input w-full pr-12" type="password" placeholder="Новый пароль" autocomplete="new-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('changeNewPassword', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <div class="relative">
        <input id="changeConfirmPassword" class="apple-input w-full pr-12" type="password" placeholder="Подтвердите пароль" autocomplete="new-password" required />
        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" onclick="togglePassword('changeConfirmPassword', this)">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <button id="saveChangePasswordBtn" type="submit" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Сохранить пароль</button>
      <div id="changePasswordConfirmError" class="text-center text-rose-400 text-sm hidden">Ошибка подтверждения</div>
      <div class="text-center">
        <button type="button" id="resendChangeCodeBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Отправить код повторно</button>
      </div>
    </form>
  </div>

  <!-- Request Editor Modal -->
  <div id="requestEditorModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <div class="glass rounded-2xl p-6 shadow-2xl w-full max-w-md flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Стать редактором</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Для получения прав редактора ваш email должен заканчиваться на @ecos.am</p>
      
      <div class="bg-amber-900/30 border border-amber-500/50 rounded-lg p-3 text-sm">
        <div class="text-amber-200 font-medium mb-1">Ваш email:</div>
        <div id="requestEditorEmail" class="text-gray-100">-</div>
      </div>
      
      <div class="flex flex-col gap-3 mt-4">
        <button id="sendEditorRequestBtn" class="apple-btn px-4 py-2 !bg-purple-600 hover:!bg-purple-500 no-gradient">Отправить запрос</button>
        <button id="cancelEditorRequestBtn" class="apple-btn px-4 py-2 bg-gray-700 hover:bg-gray-600">Отмена</button>
      </div>
      <div id="requestEditorError" class="text-center text-rose-400 text-sm hidden">Ошибка запроса</div>
    </div>
  </div>

  <!-- Confirm Editor Modal -->
  <div id="confirmEditorModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition hidden">
    <form id="confirmEditorForm" class="glass rounded-2xl p-6 shadow-2xl w-full max-w-xs flex flex-col gap-4 animate-fadeIn">
      <h2 class="text-lg font-semibold text-gray-100 mb-2 text-center">Подтверждение редактора</h2>
      <p class="text-sm text-gray-300 text-center mb-4">Введите пароль, отправленный на email</p>
      <input id="editorPassword" class="apple-input w-full text-center text-xl tracking-widest" placeholder="XXXXXXXX" maxlength="8" required />
      <button id="confirmEditorBtn" type="submit" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Активировать права</button>
      <div id="confirmEditorError" class="text-center text-rose-400 text-sm hidden">Ошибка активации</div>
      <div class="text-center">
        <button type="button" id="resendEditorPasswordBtn" class="text-sky-400 hover:text-sky-300 text-sm underline">Отправить повторно</button>
      </div>
    </form>
  </div>

  <script>
    const listEl   = document.getElementById('promptList');
    const formEl   = document.getElementById('newPromptForm');
    const inputEl  = document.getElementById('promptInput');
    const toastEl  = document.getElementById('toast');
    const saveBtn  = document.getElementById('saveBtn');
    const searchEl = document.getElementById('searchInput');
    const statsEl  = document.getElementById('stats');

    let allPrompts = [];
    let lastDate = '';

    const ENDPOINT_READ  = 'https://n8n.bitcoinlimb.com/webhook/promptake';
    const ENDPOINT_WRITE = 'https://n8n.bitcoinlimb.com/webhook/promptwrite';
    const ENDPOINT_DELETE = 'https://n8n.bitcoinlimb.com/webhook/promptdelete';
    const ENDPOINT_EDIT   = 'https://n8n.bitcoinlimb.com/webhook/promptedit';

    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      };
    }

    function handleAuthError(response) {
      if (response.status === 401) {
        localStorage.removeItem('authToken');
        showLogin();
        document.getElementById('promptList').style.display = 'none';
        document.getElementById('newPromptForm').style.display = 'none';
        document.querySelector('section').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('profileBtn').style.display = 'none';
        showToast('Сессия истекла, войдите заново', false);
        return true;
      }
      return false;
    }

    inputEl.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    function showToast(msg, ok = true) {
      toastEl.textContent = msg;
      toastEl.style.backgroundColor = ok ? '#059669' : '#DC2626';
      toastEl.classList.add('show');
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 2500);
    }

    function prettyDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleString(undefined, {
        year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }

    function cardTemplate({ id, prompt, created_at, updated_at }, idx) {
      let dateLabel = '';
      if (updated_at) {
        dateLabel = 'Создан: ' + prettyDate(created_at) + '<br>Изменён: ' + prettyDate(updated_at);
      } else if (created_at) {
        dateLabel = 'Создан: ' + prettyDate(created_at);
      }
      return `
        <div class="apple-card p-5 shadow-xl flex flex-col gap-3 fade-in group relative active:border-sky-500" data-idx="${idx}" data-id="${id}">
          <div class="flex justify-between items-center text-xs text-gray-400 select-none">
            <span>${dateLabel}</span>
            <div class="flex gap-2">
              <button class="apple-btn copyBtn px-3 py-1 text-sky-300 hover:text-sky-200" data-prompt="${encodeURIComponent(prompt)}">Копировать</button>
              <button class="apple-btn editBtn px-3 py-1 text-amber-300 hover:text-amber-200" title="Редактировать">✏️</button>
              <button class="apple-btn deleteBtn px-3 py-1 text-rose-300 hover:text-rose-200" title="Удалить">🗑️</button>
            </div>
          </div>
          <pre class="promptText collapsed whitespace-pre-wrap break-words text-gray-100 text-base leading-relaxed font-mono transition-all duration-300 bg-transparent rounded-lg px-3 py-2 cursor-pointer select-text">${prompt}</pre>
          <button class="apple-btn toggleBtn self-end text-xs text-sky-300 hover:text-sky-200 px-3 py-1">Показать больше</button>
        </div>`;
    }

    async function loadPrompts() {
      listEl.innerHTML = '<p class="text-center text-gray-400">Loading…</p>';
      try {
        const res  = await fetch(ENDPOINT_READ, { 
          mode: 'cors',
          headers: getAuthHeaders()
        });
        if (handleAuthError(res)) return;
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        let data = await res.json();
        if (!Array.isArray(data) && Array.isArray(data.data)) data = data.data;

        if (!Array.isArray(data) && data && typeof data === 'object') data = [data];
        allPrompts = (data || []).map((rec) => ({
          id: rec.id,
          prompt: rec.prompt || rec.PROMPT || rec.text || rec.body || '',
          created_at: rec.created_at || rec.date || rec.Date || rec.ts || '',
          updated_at: rec.updated_at || '',
        }));
        lastDate = allPrompts.length ? allPrompts.reduce((a, b) => ((a.updated_at || a.created_at) > (b.updated_at || b.created_at) ? a : b)).updated_at || allPrompts.reduce((a, b) => (a.created_at > b.created_at ? a : b)).created_at : '';
        renderPrompts();
        updateStats();
      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<p class="text-center text-rose-500">Ошибка загрузки промптов.</p>';
        allPrompts = [];
        updateStats();
      }
    }

    function renderPrompts() {
      const q = (searchEl.value || '').toLowerCase();
      const field = document.getElementById('searchField').value;
      const sortField = document.getElementById('sortField').value;
      const sortDir = document.getElementById('sortDir').value;
      const filterChanged = document.getElementById('filterChanged').checked;
      let filtered = allPrompts;
      if (q) {
        filtered = filtered.filter(p => (p[field] || '').toLowerCase().includes(q));
      }
      if (filterChanged) {
        filtered = filtered.filter(p => p.updated_at && p.updated_at !== '' && p.updated_at !== null);
      }
      if (showingMyPrompts && currentUserRole === 'editor' && currentAuthorId) {
        filtered = filtered.filter(p => p.author_id == currentAuthorId);
      }
      filtered = filtered.slice().sort((a, b) => {
        let av = a[sortField] || '';
        let bv = b[sortField] || '';
        if (sortField === 'created_at' || sortField === 'updated_at') {
          av = av || '';
          bv = bv || '';
          return sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
        }
        return sortDir === 'asc' ? (av > bv ? 1 : av < bv ? -1 : 0) : (av < bv ? 1 : av > bv ? -1 : 0);
      });
      listEl.innerHTML = '';
      if (!filtered.length) {
        listEl.innerHTML = '<p class="text-center text-gray-500">Промпты не найдены.</p>';
        return;
      }
      filtered.forEach((rec, idx) => {
        listEl.insertAdjacentHTML('beforeend', cardTemplate(rec, idx));
      });
    }

    function updateStats() {
      statsEl.textContent = `Всего промптов: ${allPrompts.length}${lastDate ? ` • Последний: ${prettyDate(lastDate)}` : ''}`;
    }

    function updateMyPromptsCount() {
      if (currentUserRole === 'editor' && currentAuthorId) {
        const myPrompts = allPrompts.filter(p => p.author_id == currentAuthorId);
        document.getElementById('myPromptsCount').textContent = myPrompts.length;
      }
    }

    function toggleMyPrompts() {
      showingMyPrompts = !showingMyPrompts;
      const btn = document.getElementById('viewMyPromptsBtn');
      
      if (showingMyPrompts) {
        btn.textContent = 'Показать все';
        btn.className = 'text-amber-400 hover:text-amber-300 text-sm underline mt-1';
      } else {
        btn.textContent = 'Показать только мои';
        btn.className = 'text-sky-400 hover:text-sky-300 text-sm underline mt-1';
      }
      
      renderPrompts();
      hideProfile();
    }

    const modalHtml = `
      <div id="editModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm transition">
        <div class="glass rounded-2xl p-6 shadow-2xl w-full max-w-md flex flex-col gap-4 animate-fadeIn">
          <h2 class="text-lg font-semibold text-gray-100 mb-2">Редактировать промпт</h2>
          <textarea id="editPromptInput" class="apple-input w-full" rows="4"></textarea>
          <div class="flex gap-3 justify-end">
            <button id="cancelEditBtn" class="apple-btn px-4 py-2 bg-gray-700 text-gray-300 hover:bg-gray-600">Отмена</button>
            <button id="saveEditBtn" class="apple-btn px-4 py-2 !bg-emerald-600 text-white font-semibold hover:!bg-emerald-500 no-gradient">Сохранить</button>
          </div>
        </div>
      </div>
    `;
    function showEditModal(idx) {
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modal = document.getElementById('editModal');
      const input = document.getElementById('editPromptInput');
      input.value = allPrompts[idx].prompt;
      input.focus();
      document.getElementById('cancelEditBtn').onclick = () => modal.remove();
      document.getElementById('saveEditBtn').onclick = async () => {
        const val = input.value.trim();
        if (val) {
          const id = allPrompts[idx].id;
          try {
            const editRes = await fetch(ENDPOINT_EDIT, {
              method: 'POST',
              headers: getAuthHeaders(),
              body: JSON.stringify({ id, prompt: val })
            });
            if (handleAuthError(editRes)) return;
            if (!editRes.ok) throw new Error(editRes.status + ' ' + editRes.statusText);
            showToast('Промпт обновлён');
            modal.remove();
            loadPrompts();
          } catch (err) {
            showToast('Ошибка при обновлении', false);
          }
        }
      };
    }

    listEl.addEventListener('click', (e) => {
      const card = e.target.closest('[data-idx]');
      const idx = card ? +card.dataset.idx : -1;

      if (e.target.classList.contains('copyBtn')) {
        const txt = decodeURIComponent(e.target.dataset.prompt);
        navigator.clipboard.writeText(txt).then(() => showToast('Скопировано!'));
        return;
      }
      if (e.target.classList.contains('toggleBtn')) {
        const pre   = e.target.previousElementSibling; 
        const btn   = e.target;
        pre.classList.toggle('collapsed');
        btn.textContent = pre.classList.contains('collapsed') ? 'Показать больше' : 'Показать меньше';
        return;
      }
      if (e.target.classList.contains('editBtn')) {
        showEditModal(idx);
        return;
      }
      if (e.target.classList.contains('deleteBtn')) {
        const id = allPrompts[idx].id;
        card.classList.add('opacity-0', 'scale-95', 'duration-300');
        setTimeout(async () => {
          try {
            const deleteRes = await fetch(ENDPOINT_DELETE, {
              method: 'DELETE',
              headers: getAuthHeaders(),
              body: JSON.stringify({ id: Number(id) })
            });
            if (handleAuthError(deleteRes)) return;
            if (!deleteRes.ok) throw new Error(deleteRes.status + ' ' + deleteRes.statusText);
            showToast('Промпт удалён');
            loadPrompts();
          } catch (err) {
            showToast('Ошибка при удалении', false);
          }
        }, 250);
        return;
      }
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = inputEl.value.trim();
      if (!prompt) return;
      saveBtn.disabled = true;
      try {
        const writeRes = await fetch(ENDPOINT_WRITE, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ prompt })
        });
        if (handleAuthError(writeRes)) return;
        if (!writeRes.ok) throw new Error(writeRes.status + ' ' + writeRes.statusText);
        showToast('Сохранено');
        inputEl.value = '';
        inputEl.style.height = 'auto';
        loadPrompts();
      } catch (err) {
        console.error(err);
        showToast('Error while saving', false);
      } finally {
        saveBtn.disabled = false;
      }
    });

    searchEl.addEventListener('input', renderPrompts);

    document.getElementById('searchField').addEventListener('change', renderPrompts);
    document.getElementById('sortField').addEventListener('change', renderPrompts);
    document.getElementById('sortDir').addEventListener('change', renderPrompts);
    document.getElementById('filterChanged').addEventListener('change', renderPrompts);

    document.getElementById('exportBtn').addEventListener('click', () => {
      const dataStr = JSON.stringify(allPrompts, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prompts_export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importInput').click();
    });
    document.getElementById('importInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (Array.isArray(imported)) {

            showToast('Импортировано: ' + imported.length);

          } else {
            showToast('Файл не содержит массив промптов', false);
          }
        } catch {
          showToast('Ошибка при импорте', false);
        }
      };
      reader.readAsText(file);
    });

    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginInput = document.getElementById('loginInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');

    const registerModal = document.getElementById('registerModal');
    const registerForm = document.getElementById('registerForm');
    const registerEmail = document.getElementById('registerEmail');
    const registerLogin = document.getElementById('registerLogin');
    const registerPassword = document.getElementById('registerPassword');
    const registerName = document.getElementById('registerName');
    const registerBtn = document.getElementById('registerBtn');
    const registerError = document.getElementById('registerError');

    const confirmModal = document.getElementById('confirmModal');
    const confirmForm = document.getElementById('confirmForm');
    const confirmCode = document.getElementById('confirmCode');
    const confirmBtn = document.getElementById('confirmBtn');
    const confirmError = document.getElementById('confirmError');

    const resetModal = document.getElementById('resetModal');
    const resetForm = document.getElementById('resetForm');
    const resetEmail = document.getElementById('resetEmail');
    const resetBtn = document.getElementById('resetBtn');
    const resetError = document.getElementById('resetError');

    const resetConfirmModal = document.getElementById('resetConfirmModal');
    const resetConfirmForm = document.getElementById('resetConfirmForm');
    const resetCode = document.getElementById('resetCode');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const resetConfirmBtn = document.getElementById('resetConfirmBtn');
    const resetConfirmError = document.getElementById('resetConfirmError');

    const profileModal = document.getElementById('profileModal');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const changePasswordConfirmModal = document.getElementById('changePasswordConfirmModal');
    const changePasswordConfirmForm = document.getElementById('changePasswordConfirmForm');

    let pendingEmail = '';
    let pendingResetEmail = '';
    let currentUserEmail = '';
    let currentUserRole = 'user';
    let currentAuthorId = null;
    let showingMyPrompts = false;

    function showLogin() {
      loginModal.style.display = 'flex';
      registerModal.style.display = 'none';
      confirmModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function hideLogin() {
      loginModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showRegister() {
      registerModal.style.display = 'flex';
      loginModal.style.display = 'none';
      confirmModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function hideRegister() {
      registerModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showConfirm() {
      confirmModal.style.display = 'flex';
      registerModal.style.display = 'none';
      loginModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function hideConfirm() {
      confirmModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showReset() {
      resetModal.style.display = 'flex';
      loginModal.style.display = 'none';
      registerModal.style.display = 'none';
      confirmModal.style.display = 'none';
      resetConfirmModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function hideReset() {
      resetModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showResetConfirm() {
      resetConfirmModal.style.display = 'flex';
      resetModal.style.display = 'none';
      loginModal.style.display = 'none';
      registerModal.style.display = 'none';
      confirmModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function hideResetConfirm() {
      resetConfirmModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showProfile() {
      const token = localStorage.getItem('authToken');
      if (token) {
        try {
          // Декодируем JWT токен (простое декодирование base64, без проверки подписи)
          const payload = JSON.parse(atob(token.split('.')[1]));
          document.getElementById('profileLogin').textContent = payload.login || '-';
          document.getElementById('profileEmail').textContent = payload.email || '-';
          currentUserEmail = payload.email || '';
          currentUserRole = payload.isEditor ? 'editor' : 'user';
          currentAuthorId = payload.authorId || null;
          
          // Обновляем отображение статуса
          const roleEl = document.getElementById('profileRole');
          const requestEditorBtn = document.getElementById('requestEditorBtn');
          const myPromptsSection = document.getElementById('myPromptsSection');
          
          if (payload.isEditor) {
            roleEl.textContent = '🔸 Редактор';
            roleEl.className = 'text-purple-300 font-medium';
            requestEditorBtn.classList.add('hidden');
            myPromptsSection.classList.remove('hidden');
            updateMyPromptsCount();
          } else {
            roleEl.textContent = '👤 Пользователь';
            roleEl.className = 'text-gray-100 font-medium';
            // Показываем кнопку для всех пользователей (проверка email будет при нажатии)
            requestEditorBtn.classList.remove('hidden');
            myPromptsSection.classList.add('hidden');
          }
        } catch (e) {
          document.getElementById('profileLogin').textContent = '-';
          document.getElementById('profileEmail').textContent = '-';
        }
      }
      profileModal.style.display = 'flex';
      document.body.classList.add('overflow-hidden');
    }
    function hideProfile() {
      profileModal.style.display = 'none';
      changePasswordModal.style.display = 'none';
      changePasswordConfirmModal.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    function showChangePassword() {
      changePasswordModal.style.display = 'flex';
      profileModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function showChangePasswordConfirm() {
      changePasswordConfirmModal.style.display = 'flex';
      changePasswordModal.style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    function isAuthed() {
      return !!localStorage.getItem('authToken');
    }
    function logout() {
      localStorage.removeItem('authToken');
      location.reload();
    }

    if (!isAuthed()) {
      showLogin();
      document.getElementById('promptList').style.display = 'none';
      document.getElementById('newPromptForm').style.display = 'none';
      document.querySelector('section').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('profileBtn').style.display = 'none';
    } else {
      hideLogin();
      document.getElementById('promptList').style.display = '';
      document.getElementById('newPromptForm').style.display = '';
      document.querySelector('section').style.display = '';
      document.getElementById('logoutBtn').style.display = '';
      document.getElementById('profileBtn').style.display = '';
    }

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      loginBtn.disabled = true;
      loginError.classList.add('hidden');
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/authorlogin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login: loginInput.value.trim(), password: passwordInput.value })
        });
        const data = await res.json();
        if (res.ok && data && data.token) {
          localStorage.setItem('authToken', data.token);
          hideLogin();
          document.getElementById('promptList').style.display = '';
          document.getElementById('newPromptForm').style.display = '';
          document.querySelector('section').style.display = '';
          document.getElementById('logoutBtn').style.display = '';
          document.getElementById('profileBtn').style.display = '';
          loadPrompts();
        } else {
          loginError.textContent = data && data.error ? data.error : 'Ошибка входа';
          loginError.classList.remove('hidden');
        }
      } catch {
        loginError.textContent = 'Ошибка соединения';
        loginError.classList.remove('hidden');
      } finally {
        loginBtn.disabled = false;
      }
    };

    document.getElementById('showRegisterBtn').onclick = showRegister;
    document.getElementById('showLoginBtn').onclick = showLogin;
    document.getElementById('showResetBtn').onclick = showReset;
    document.getElementById('showLoginFromResetBtn').onclick = showLogin;

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      registerBtn.disabled = true;
      registerError.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: registerEmail.value.trim(),
            login: registerLogin.value.trim(),
            password: registerPassword.value,
            name: registerName.value.trim()
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          pendingEmail = registerEmail.value.trim();
          showConfirm();
          showToast('Код подтверждения отправлен на email', true);
        } else {
          registerError.textContent = data.error || 'Ошибка регистрации';
          registerError.classList.remove('hidden');
        }
      } catch {
        registerError.textContent = 'Ошибка соединения';
        registerError.classList.remove('hidden');
      } finally {
        registerBtn.disabled = false;
      }
    };

    confirmForm.onsubmit = async (e) => {
      e.preventDefault();
      confirmBtn.disabled = true;
      confirmError.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: pendingEmail,
            code: confirmCode.value.trim()
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Аккаунт успешно подтвержден!', true);
          hideConfirm();
          showLogin();
        } else {
          confirmError.textContent = data.error || 'Неверный код подтверждения';
          confirmError.classList.remove('hidden');
        }
      } catch {
        confirmError.textContent = 'Ошибка соединения';
        confirmError.classList.remove('hidden');
      } finally {
        confirmBtn.disabled = false;
      }
    };

    document.getElementById('resendCodeBtn').onclick = async () => {
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: pendingEmail,
            resend: true
          })
        });
        
        if (res.ok) {
          showToast('Код отправлен повторно', true);
        } else {
          showToast('Ошибка отправки кода', false);
        }
      } catch {
        showToast('Ошибка соединения', false);
      }
    };

    resetForm.onsubmit = async (e) => {
      e.preventDefault();
      resetBtn.disabled = true;
      resetError.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: resetEmail.value.trim()
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          pendingResetEmail = resetEmail.value.trim();
          showResetConfirm();
          showToast('Код восстановления отправлен на email', true);
        } else {
          resetError.textContent = data.error || 'Ошибка восстановления пароля';
          resetError.classList.remove('hidden');
        }
      } catch {
        resetError.textContent = 'Ошибка соединения';
        resetError.classList.remove('hidden');
      } finally {
        resetBtn.disabled = false;
      }
    };

    resetConfirmForm.onsubmit = async (e) => {
      e.preventDefault();
      
      // Проверяем что пароли совпадают
      if (newPassword.value !== confirmPassword.value) {
        resetConfirmError.textContent = 'Пароли не совпадают';
        resetConfirmError.classList.remove('hidden');
        return;
      }
      
      if (newPassword.value.length < 6) {
        resetConfirmError.textContent = 'Пароль должен содержать минимум 6 символов';
        resetConfirmError.classList.remove('hidden');
        return;
      }
      
      resetConfirmBtn.disabled = true;
      resetConfirmError.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: pendingResetEmail,
            code: resetCode.value.trim(),
            newPassword: newPassword.value
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Пароль успешно изменен!', true);
          hideResetConfirm();
          showLogin();
          // Очищаем поля
          resetEmail.value = '';
          resetCode.value = '';
          newPassword.value = '';
          confirmPassword.value = '';
        } else {
          resetConfirmError.textContent = data.error || 'Неверный код или ошибка сохранения';
          resetConfirmError.classList.remove('hidden');
        }
      } catch {
        resetConfirmError.textContent = 'Ошибка соединения';
        resetConfirmError.classList.remove('hidden');
      } finally {
        resetConfirmBtn.disabled = false;
      }
    };

    document.getElementById('resendResetCodeBtn').onclick = async () => {
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: pendingResetEmail,
            resend: true
          })
        });
        
        if (res.ok) {
          showToast('Код отправлен повторно', true);
        } else {
          showToast('Ошибка отправки кода', false);
        }
      } catch {
        showToast('Ошибка соединения', false);
      }
    };

    // Event listeners для профиля и смены пароля
    document.getElementById('closeProfileBtn').onclick = hideProfile;
    document.getElementById('changePasswordBtn').onclick = showChangePassword;
    document.getElementById('cancelChangePasswordBtn').onclick = hideProfile;
    
    // Event listeners для системы редакторов
    document.getElementById('requestEditorBtn').onclick = showRequestEditor;
    document.getElementById('cancelEditorRequestBtn').onclick = hideProfile;
    document.getElementById('sendEditorRequestBtn').onclick = sendEditorRequest;
    document.getElementById('resendEditorPasswordBtn').onclick = resendEditorPassword;
    document.getElementById('viewMyPromptsBtn').onclick = toggleMyPrompts;
    
    // Функции для модалов редактора
    function showRequestEditor() {
      document.getElementById('requestEditorEmail').textContent = currentUserEmail;
      document.getElementById('requestEditorModal').style.display = 'flex';
      document.getElementById('profileModal').style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    
    function showConfirmEditor() {
      document.getElementById('confirmEditorModal').style.display = 'flex';
      document.getElementById('requestEditorModal').style.display = 'none';
      document.body.classList.add('overflow-hidden');
    }
    
    function hideEditorModals() {
      document.getElementById('requestEditorModal').style.display = 'none';
      document.getElementById('confirmEditorModal').style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    }
    
    async function sendEditorRequest() {
      const errorEl = document.getElementById('requestEditorError');
      const btn = document.getElementById('sendEditorRequestBtn');
      
      // Проверяем email на клиенте
      if (!currentUserEmail.endsWith('@ecos.am')) {
        errorEl.textContent = 'Email должен заканчиваться на @ecos.am';
        errorEl.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/request-editor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Пароль отправлен на email!', true);
          showConfirmEditor();
        } else {
          errorEl.textContent = data.error || 'Ошибка отправки запроса';
          errorEl.classList.remove('hidden');
        }
      } catch {
        errorEl.textContent = 'Ошибка соединения';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function resendEditorPassword() {
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/request-editor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            resend: true
          })
        });
        
        if (res.ok) {
          showToast('Пароль отправлен повторно', true);
        } else {
          showToast('Ошибка отправки пароля', false);
        }
      } catch {
        showToast('Ошибка соединения', false);
      }
    }

    // Форма запроса смены пароля
    changePasswordForm.onsubmit = async (e) => {
      e.preventDefault();
      const sendBtn = document.getElementById('sendChangeCodeBtn');
      const errorEl = document.getElementById('changePasswordError');
      
      sendBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showChangePasswordConfirm();
          showToast('Код для смены пароля отправлен на email', true);
        } else {
          errorEl.textContent = data.error || 'Ошибка отправки кода';
          errorEl.classList.remove('hidden');
        }
      } catch {
        errorEl.textContent = 'Ошибка соединения';
        errorEl.classList.remove('hidden');
      } finally {
        sendBtn.disabled = false;
      }
    };

    // Форма подтверждения смены пароля
    changePasswordConfirmForm.onsubmit = async (e) => {
      e.preventDefault();
      
      const newPasswordField = document.getElementById('changeNewPassword');
      const confirmPasswordField = document.getElementById('changeConfirmPassword');
      const codeField = document.getElementById('changeCode');
      const saveBtn = document.getElementById('saveChangePasswordBtn');
      const errorEl = document.getElementById('changePasswordConfirmError');
      
      // Проверяем что пароли совпадают
      if (newPasswordField.value !== confirmPasswordField.value) {
        errorEl.textContent = 'Пароли не совпадают';
        errorEl.classList.remove('hidden');
        return;
      }
      
      if (newPasswordField.value.length < 6) {
        errorEl.textContent = 'Пароль должен содержать минимум 6 символов';
        errorEl.classList.remove('hidden');
        return;
      }
      
      saveBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            code: codeField.value.trim(),
            newPassword: newPasswordField.value
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Пароль успешно изменен!', true);
          hideProfile();
          // Очищаем поля
          codeField.value = '';
          newPasswordField.value = '';
          confirmPasswordField.value = '';
        } else {
          errorEl.textContent = data.error || 'Неверный код или ошибка сохранения';
          errorEl.classList.remove('hidden');
        }
      } catch {
        errorEl.textContent = 'Ошибка соединения';
        errorEl.classList.remove('hidden');
      } finally {
        saveBtn.disabled = false;
      }
    };

    // Повторная отправка кода для смены пароля
    document.getElementById('resendChangeCodeBtn').onclick = async () => {
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/reset-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            resend: true
          })
        });
        
        if (res.ok) {
          showToast('Код отправлен повторно', true);
        } else {
          showToast('Ошибка отправки кода', false);
        }
      } catch {
        showToast('Ошибка соединения', false);
      }
    };

    // Обработчик формы подтверждения редактора
    document.getElementById('confirmEditorForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const passwordField = document.getElementById('editorPassword');
      const btn = document.getElementById('confirmEditorBtn');
      const errorEl = document.getElementById('confirmEditorError');
      
      btn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        const res = await fetch('https://n8n.bitcoinlimb.com/webhook/confirm-editor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            password: passwordField.value.trim()
          })
        });
        
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Права редактора активированы! Перелогиньтесь.', true);
          hideEditorModals();
          hideProfile();
          // Очищаем поля
          passwordField.value = '';
          // Предлагаем перелогиниться для обновления токена
          setTimeout(() => {
            if (confirm('Для применения прав редактора необходимо перелогиниться. Выйти сейчас?')) {
              logout();
            }
          }, 2000);
        } else {
          errorEl.textContent = data.error || 'Неверный пароль или ошибка активации';
          errorEl.classList.remove('hidden');
        }
      } catch {
        errorEl.textContent = 'Ошибка соединения';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false;
      }
    };

    window.logout = logout;
    window.showProfile = showProfile;

    // Функция для показа/скрытия пароля
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const svg = button.querySelector('svg');
      
      if (input.type === 'password') {
        input.type = 'text';
        // Иконка "скрыть пароль" (перечеркнутый глаз)
        svg.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L5.636 5.636m4.242 4.242L14.12 14.12m-4.242-4.242L5.636 5.636m8.484 8.484l4.242 4.242M19.5 12c0 1.232-.046 2.453-.138 3.662a4.006 4.006 0 01-3.7 3.7 48.678 48.678 0 01-7.324 0 4.006 4.006 0 01-3.7-3.7c-.017-.22-.032-.441-.046-.663M5.636 5.636l13.728 13.728"></path>
        `;
      } else {
        input.type = 'password';
        // Иконка "показать пароль" (обычный глаз)
        svg.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        `;
      }
    }
    
    window.togglePassword = togglePassword;

    loadPrompts();
  </script>
</body>
</html>
